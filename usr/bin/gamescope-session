#!/bin/sh

# Source global variables
. /etc/gamescope-session.conf

# Some environment variables by default (taken from Deck session)
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0
export STEAM_USE_MANGOAPP=1

# Source environment from ~/.config/environment.d
set -a
for i in "${HOME}"/.config/environment.d/*.conf ;
do
    [[ -f "${i}" ]] && . "${i}"
done
set +a

# Use cursor if file exist
if [ -z "$CURSOR_FILE" ] ; then
    CURSOR_FILE="${HOME}/.local/share/Steam/tenfoot/resource/images/cursors/arrow_right.png"
fi
CURSOR=""
if [ -f "$CURSOR_FILE" ] ; then
    CURSOR="--cursor ${CURSOR_FILE}"
fi

# Define session if not overriden
if [ -z "$STEAMCMD" ] ; then
    STEAMCMD="steam -tenfoot -steamos -pipewire-dmabuf"
    # Check beta branch and select prefered UI
    STEAM_BETA_FILE="${HOME}/.local/share/Steam/package/beta"
    if [ -f "$STEAM_BETA_FILE" ] ; then
        BETA=$(cat "${STEAM_BETA_FILE}")
        if [[ $BETA =~ steampal ]] ; then
            STEAMCMD="steam -gamepadui -steamos -pipewire-dmabuf"
        fi
    fi
fi
if [ -z "$GAMESCOPECMD" ] ; then
    GAMESCOPECMD="/usr/bin/gamescope \
      $CURSOR \
      -e \
      -f \
      -W $SCREEN_W -H $SCREEN_H \
      -w $RENDER_W -h $RENDER_H \
      --xwayland-count 2"
fi

# Workaround for Steam login issue while Steam client change propagates out of Beta
touch "${HOME}"/.steam/root/config/SteamAppData.vdf || true

# Log rotate the last session
if [ -f "${HOME}"/.steam-tweaks.log ]; then
    cp "${HOME}"/.steam-tweaks.log "${HOME}"/.steam-tweaks.log.old
fi
if [ -f "${HOME}"/.steam-stdout.log ]; then
    cp "${HOME}"/.steam-stdout.log "${HOME}"/.steam-stdout.log.old
fi
if [ -f "${HOME}"/.gamescope-stdout.log ]; then
    cp "${HOME}"/.gamescope-stdout.log "${HOME}"/.gamescope-stdout.log.old
fi

# Run steam-tweaks if exists
if command -v steam-tweaks > /dev/null; then
    steam-tweaks > "${HOME}"/.steam-tweaks.log
fi

# Start gamescope compositor, log it's output and background it
$GAMESCOPECMD > "${HOME}"/.gamescope-stdout.log 2>&1 &
gamescope_pid="$!"

# If we have mangoapp binary start it
if command -v mangoapp > /dev/null; then
    mangoapp &
fi

# Start Steam client
$STEAMCMD > "${HOME}"/.steam-stdout.log 2>&1

# When the client exits, kill gamescope nicely
kill $gamescope_pid
