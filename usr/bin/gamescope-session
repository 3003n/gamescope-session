#!/bin/sh

source /etc/gamescope-session.conf
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0

# Source environment from ~/.config
for i in "~/.config/environment.d/*.conf" ;
do
    [[ -f "${i}" ]] && source "${i}"
done

# Define session if not overriden
if [ -z "$STEAMCMD" ] ; then
    STEAMCMD="steam -tenfoot -steamos -fulldesktopres"
fi
if [ -z "$GAMESCOPECMD" ] ; then
    GAMESCOPECMD="/usr/bin/gamescope -e -f -W $SCREEN_W -H $SCREEN_H -w $RENDER_W -h $RENDER_H"
fi

# Workaround for Steam login issue while Steam client change propagates out of Beta
touch ~/.steam/root/config/SteamAppData.vdf || true

# Log rotate the last session
if [ -f ~/.steam-tweaks.log ]; then
	cp ~/.steam-tweaks.log ~/.steam-tweaks.log.old
fi
if [ -f ~/.steam-stdout.log ]; then
	cp ~/.steam-stdout.log ~/.steam-stdout.log.old
fi

# Run steam-tweaks if exists
if command -v steam-tweaks > /dev/null; then
	steam-tweaks > ~/.steam-tweaks.log
fi

$GAMESCOPECMD -- $STEAMCMD > ~/.steam-stdout.log 2>&1
